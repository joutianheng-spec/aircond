<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Room Maintenance Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); color: #333; line-height: 1.6; padding: 15px; min-height: 100vh; }
        .container { max-width: 100%; margin: 0 auto; }
        .sync-status { background: #ffeb3b; padding: 12px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .sync-status.online { background: #4caf50; color: white; }
        .sync-status.offline { background: #f44336; color: white; }
        header { background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        h1 { color: #1a2a6c; margin-bottom: 10px; font-size: 1.8rem; }
        .subtitle { color: #666; font-size: 1rem; }
        .dashboard { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
        @media (min-width: 768px) { .dashboard { grid-template-columns: 1fr 1fr; } }
        .card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .card h2 { color: #1a2a6c; margin-bottom: 15px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
        .card h2 i { color: #b21f1f; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { text-align: center; padding: 15px; border-radius: 10px; background: #f8f9fa; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #1a2a6c; }
        .stat-label { font-size: 0.9rem; color: #666; }
        .controls, .form-group { display: flex; flex-direction: column; gap: 15px; }
        .form-group { gap: 5px; }
        label { font-weight: 600; color: #444; }
        select, input, button { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button { background: linear-gradient(to right, #1a2a6c, #b21f1f); color: white; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .secondary-btn { background: linear-gradient(to right, #666, #999); }
        .share-btn { background: linear-gradient(to right, #4caf50, #2e7d32); }
        .edit-btn { background: linear-gradient(to right, #ff9800, #ff5722); }
        .delete-btn { background: linear-gradient(to right, #f44336, #d32f2f); }
        .rooms-container { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); margin-bottom: 20px; }
        .rooms-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .filter-controls { display: flex; gap: 10px; }
        .rooms-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        .room-card { background: white; border-radius: 10px; padding: 15px 10px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: all 0.3s; cursor: pointer; border-left: 5px solid #ddd; }
        .room-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .room-number { font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; }
        .room-status { font-size: 0.8rem; padding: 3px 8px; border-radius: 20px; display: inline-block; }
        .maintained { border-left-color: #4CAF50; background-color: #E8F5E9; }
        .maintained .room-status { background-color: #4CAF50; color: white; }
        .not-maintained { border-left-color: #F44336; background-color: #FFEBEE; }
        .not-maintained .room-status { background-color: #F44336; color: white; }
        .history-container { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .history-list { max-height: 300px; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; align-items: center; }
        .history-room { font-weight: bold; }
        .history-date { color: #666; }
        .history-actions { display: flex; gap: 8px; }
        .action-btn { padding: 6px 10px; font-size: 0.8rem; border-radius: 5px; }
        .no-data { text-align: center; color: #999; padding: 20px; }
        .legend { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .legend-color { width: 15px; height: 15px; border-radius: 3px; }
        .maintained-color { background-color: #4CAF50; }
        .not-maintained-color { background-color: #F44336; }
        .notification { position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1000; }
        .notification.show { transform: translateY(0); opacity: 1; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal h3 { margin-bottom: 15px; color: #1a2a6c; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex: 1; }
        .share-section { background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 15px; margin: 20px 0; text-align: center; }
        .share-link { background: #f5f5f5; padding: 15px; border-radius: 10px; margin: 15px 0; word-break: break-all; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <div id="syncStatus" class="sync-status">
            <i class="fas fa-sync fa-spin"></i> Connecting to cloud...
        </div>
        
        <header>
            <h1><i class="fas fa-hotel"></i> Hotel Room Maintenance Manager</h1>
            <p class="subtitle">Real-time sync across all devices | Sept 2025 - Dec 2026</p>
        </header>
        
        <div class="share-section">
            <h2><i class="fas fa-share-alt"></i> Share with Team</h2>
            <p>Copy this link and share with your team members:</p>
            <div class="share-link" id="shareLink">Loading...</div>
            <button class="share-btn" onclick="copyShareLink()"><i class="fas fa-copy"></i> Copy Share Link</button>
            <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">All team members will see real-time updates when anyone makes changes</p>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h2><i class="fas fa-chart-pie"></i> Maintenance Overview</h2>
                <div class="stats">
                    <div class="stat-item"><div class="stat-value" id="maintainedCount">0</div><div class="stat-label">Maintained</div></div>
                    <div class="stat-item"><div class="stat-value" id="notMaintainedCount">0</div><div class="stat-label">Not Maintained</div></div>
                    <div class="stat-item"><div class="stat-value" id="thisMonthCount">0</div><div class="stat-label">This Month</div></div>
                    <div class="stat-item"><div class="stat-value" id="totalRooms">0</div><div class="stat-label">Total Rooms</div></div>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-tools"></i> Record Maintenance</h2>
                <div class="controls">
                    <div class="form-group"><label for="roomSelect">Select Room:</label><select id="roomSelect"></select></div>
                    <div class="form-group"><label for="maintenanceDate">Maintenance Date:</label><input type="date" id="maintenanceDate"></div>
                    <button id="addMaintenance"><i class="fas fa-plus-circle"></i> Add Maintenance Record</button>
                    <button id="manageRecords" class="secondary-btn"><i class="fas fa-edit"></i> Manage Existing Records</button>
                </div>
            </div>
        </div>
        
        <div class="rooms-container">
            <div class="rooms-header">
                <h2><i class="fas fa-door-open"></i> Room Status</h2>
                <div class="filter-controls"><select id="monthSelect"></select></div>
            </div>
            <div class="rooms-grid" id="roomGrid"></div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color maintained-color"></div><span>Maintained</span></div>
                <div class="legend-item"><div class="legend-color not-maintained-color"></div><span>Not Maintained</span></div>
            </div>
        </div>
        
        <div class="history-container">
            <h2><i class="fas fa-history"></i> Maintenance History</h2>
            <div class="history-list" id="maintenanceHistory"></div>
        </div>
    </div>
    
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3><i class="fas fa-edit"></i> Edit Maintenance Record</h3>
            <div class="form-group"><label for="editRoom">Room:</label><input type="text" id="editRoom" readonly></div>
            <div class="form-group"><label for="editDate">Maintenance Date:</label><input type="date" id="editDate"></div>
            <div class="modal-actions">
                <button id="saveEdit" class="edit-btn"><i class="fas fa-save"></i> Save Changes</button>
                <button id="deleteRecord" class="delete-btn"><i class="fas fa-trash"></i> Delete</button>
                <button id="cancelEdit" class="secondary-btn"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="manageModal">
        <div class="modal-content">
            <h3><i class="fas fa-cog"></i> Manage Maintenance Records</h3>
            <div class="form-group"><label for="manageRoomSelect">Select Room:</label><select id="manageRoomSelect"></select></div>
            <div id="roomRecords"></div>
            <div class="modal-actions"><button id="closeManage" class="secondary-btn"><i class="fas fa-times"></i> Close</button></div>
        </div>
    </div>
    
    <div class="notification" id="notification">Maintenance record added successfully!</div>

        // ==================== SUPABASE CONFIGURATION ====================
        // ‚úÖ YOUR CREDENTIALS ARE PRE-FILLED
        const SUPABASE_URL = 'https://vbercbwanfitropwhvuh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiZXJjYndhbmZpdHJvcHdodnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Mzk5NzksImV4cCI6MjA3NjExNTk3OX0.KND3DidiHdiSLwBezjXf1qw5KI997IKBcswGMrXiQrc';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==================== APPLICATION CODE ====================
        let maintenanceData = {};
        let currentEditRecord = null;
        
        // Generate room numbers (101-155, EXCLUDING: 104, 109, 114, 119, 154)
        const excludedRooms = [104, 109, 114, 119, 154];
        const allRooms = [];
        for (let i = 101; i <= 155; i++) {
            if (!excludedRooms.includes(i)) allRooms.push(i);
        }
        
        // Generate month options (Sept 2025 - Dec 2026)
        const months = [];
        const startYear = 2025, startMonth = 8; // Sept
        const endYear = 2026, endMonth = 11;    // Dec
        let y = startYear, m = startMonth;
        while (y < endYear || (y === endYear && m <= endMonth)) {
            months.push({ year: y, month: m, name: new Date(y, m).toLocaleDateString('en-US', { year: 'numeric', month: 'long' }) });
            m++; if (m > 11) { m = 0; y++; }
        }
        
        // ==================== CORE FUNCTIONS ====================
        async function initializeApp() {
            initializeUI();
            await loadMaintenanceData();
            setupRealtimeSubscription();
        }
        
        async function loadMaintenanceData() {
            try {
                const { data, error } = await supabase.from('maintenance_records').select('*').order('maintenance_date', { ascending: false });
                if (error) throw error;
                maintenanceData = {};
                if (data) {
                    data.forEach(r => {
                        const key = r.room_number.toString();
                        if (!maintenanceData[key]) maintenanceData[key] = [];
                        maintenanceData[key].push({ date: r.maintenance_date, id: r.id });
                    });
                }
                updateDisplay();
                updateSyncStatus(true, '‚úÖ Connected to cloud');
            } catch (error) {
                console.error('Load error:', error);
                updateSyncStatus(false, '‚ùå Cloud offline - using local data');
                const local = localStorage.getItem('hotelMaintenanceData');
                if (local) { maintenanceData = JSON.parse(local); updateDisplay(); }
            }
        }
        
        function setupRealtimeSubscription() {
            supabase.channel('maintenance-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'maintenance_records' }, async () => {
                    await loadMaintenanceData();
                    showNotification('üîÑ Data updated in real-time');
                })
                .subscribe();
        }
        
        async function addMaintenanceRecord() {
            const room = document.getElementById('roomSelect').value;
            const date = document.getElementById('maintenanceDate').value;
            if (!room || !date) { alert('Please select a room and date'); return; }
            
            try {
                const { data, error } = await supabase.from('maintenance_records').insert([{ room_number: parseInt(room), maintenance_date: date }]).select();
                if (error) throw error;
                if (!maintenanceData[room]) maintenanceData[room] = [];
                maintenanceData[room].push({ date: date, id: data[0].id });
                updateDisplay();
                document.getElementById('maintenanceDate').valueAsDate = new Date();
                showNotification('‚úÖ Record added and synced!');
            } catch (error) {
                console.error('Add error:', error);
                alert('‚ùå Failed to sync to cloud.');
            }
        }
        
        function updateDisplay() {
            updateRoomGrid(); updateStats(); updateMaintenanceHistory();
        }
        
        function updateRoomGrid() {
            const grid = document.getElementById('roomGrid');
            grid.innerHTML = '';
            const [year, month] = document.getElementById('monthSelect').value.split('-').map(Number);
            
            allRooms.forEach(room => {
                const card = document.createElement('div');
                card.className = 'room-card';
                const number = document.createElement('div'); number.className = 'room-number'; number.textContent = room;
                const status = document.createElement('div'); status.className = 'room-status';
                
                const records = maintenanceData[room] || [];
                const maintained = records.find(r => { const d = new Date(r.date); return d.getFullYear() === year && d.getMonth() === month; });
                
                if (maintained) {
                    card.classList.add('maintained');
                    const d = new Date(maintained.date);
                    status.textContent = `Maintained: ${d.getDate()}/${d.getMonth()+1}`;
                } else {
                    card.classList.add('not-maintained');
                    status.textContent = 'Not Maintained';
                }
                card.appendChild(number); card.appendChild(status); grid.appendChild(card);
            });
        }
        
        function updateStats() {
            const [year, month] = document.getElementById('monthSelect').value.split('-').map(Number);
            const today = new Date();
            let maintained = 0, notMaintained = 0, thisMonth = 0;
            
            allRooms.forEach(room => {
                const records = maintenanceData[room] || [];
                const inSelectedMonth = records.find(r => { const d = new Date(r.date); return d.getFullYear() === year && d.getMonth() === month; });
                const inThisMonth = records.find(r => { const d = new Date(r.date); return d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth(); });
                
                if (inSelectedMonth) maintained++; else notMaintained++;
                if (inThisMonth) thisMonth++;
            });
            
            document.getElementById('maintainedCount').textContent = maintained;
            document.getElementById('notMaintainedCount').textContent = notMaintained;
            document.getElementById('thisMonthCount').textContent = thisMonth;
            document.getElementById('totalRooms').textContent = allRooms.length;
        }
        
        function updateMaintenanceHistory() {
            const container = document.getElementById('maintenanceHistory');
            let allRecords = [];
            Object.keys(maintenanceData).forEach(room => {
                if (allRooms.includes(parseInt(room))) {
                    maintenanceData[room].forEach(r => allRecords.push({ room, date: r.date, timestamp: new Date(r.date).getTime(), id: r.id }));
                }
            });
            allRecords.sort((a,b) => b.timestamp - a.timestamp);
            
            container.innerHTML = allRecords.length ? '' : '<div class="no-data">No records yet</div>';
            allRecords.forEach(r => {
                const item = document.createElement('div'); item.className = 'history-item';
                const date = new Date(r.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                item.innerHTML = `
                    <div><div class="history-room">Room ${r.room}</div><div class="history-date">${date}</div></div>
                    <div class="history-actions"><button class="action-btn edit-btn" data-room="${r.room}" data-date="${r.date}" data-id="${r.id}"><i class="fas fa-edit"></i> Edit</button></div>
                `;
                container.appendChild(item);
            });
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => openEditModal(btn.getAttribute('data-room'), btn.getAttribute('data-date'), btn.getAttribute('data-id')));
            });
        }
        
        function initializeUI() {
            const monthSelect = document.getElementById('monthSelect');
            monthSelect.innerHTML = ''; months.forEach(m => { const o = document.createElement('option'); o.value = `${m.year}-${m.month}`; o.textContent = m.name; monthSelect.appendChild(o); });
            monthSelect.value = `${new Date().getFullYear()}-${new Date().getMonth()}`;
            
            const roomSelect = document.getElementById('roomSelect'), manageSelect = document.getElementById('manageRoomSelect');
            roomSelect.innerHTML = ''; manageSelect.innerHTML = '';
            allRooms.forEach(room => {
                const o1 = document.createElement('option'); o1.value = room; o1.textContent = `Room ${room}`; roomSelect.appendChild(o1);
                const o2 = document.createElement('option'); o2.value = room; o2.textContent = `Room ${room}`; manageSelect.appendChild(o2);
            });
            document.getElementById('maintenanceDate').valueAsDate = new Date();
            document.getElementById('shareLink').textContent = window.location.href;
        }
        
        function updateSyncStatus(online, msg) {
            const e = document.getElementById('syncStatus');
            e.className = `sync-status ${online ? 'online' : 'offline'}`;
            e.innerHTML = online ? `<i class="fas fa-cloud"></i> ${msg}` : `<i class="fas fa-cloud-slash"></i> ${msg}`;
        }
        
        function copyShareLink() {
            navigator.clipboard.writeText(window.location.href).then(() => showNotification('‚úÖ Link copied!'));
        }
        
        function showNotification(msg) {
            const n = document.getElementById('notification');
            n.textContent = msg; n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }
        
        function openEditModal(room, date, id) {
            currentEditRecord = { room, date, id };
            document.getElementById('editRoom').value = `Room ${room}`;
            document.getElementById('editDate').value = date;
            document.getElementById('editModal').style.display = 'flex';
        }
        
        async function saveEditedRecord() {
            if (!currentEditRecord) return;
            const newDate = document.getElementById('editDate').value;
            if (!newDate) { alert('Select a date'); return; }
            try {
                const { error } = await supabase.from('maintenance_records').update({ maintenance_date: newDate }).eq('id', currentEditRecord.id);
                if (error) throw error;
                const records = maintenanceData[currentEditRecord.room];
                const idx = records.findIndex(r => r.id === currentEditRecord.id);
                if (idx !== -1) records[idx].date = newDate;
                updateDisplay();
                document.getElementById('editModal').style.display = 'none';
                showNotification('‚úÖ Record updated!');
            } catch (error) { console.error('Update error:', error); alert('‚ùå Update failed'); }
        }
        
        async function deleteRecord() {
            if (!currentEditRecord || !confirm('Delete this record?')) return;
            try {
                const { error } = await supabase.from('maintenance_records').delete().eq('id', currentEditRecord.id);
                if (error) throw error;
                maintenanceData[currentEditRecord.room] = maintenanceData[currentEditRecord.room].filter(r => r.id !== currentEditRecord.id);
                if (maintenanceData[currentEditRecord.room].length === 0) delete maintenanceData[currentEditRecord.room];
                updateDisplay();
                document.getElementById('editModal').style.display = 'none';
                showNotification('‚úÖ Record deleted!');
            } catch (error) { console.error('Delete error:', error); alert('‚ùå Delete failed'); }
        }
        
        function openManageModal() {
            document.getElementById('manageModal').style.display = 'flex';
            updateRoomRecordsList();
        }
        
        function updateRoomRecordsList() {
            const room = document.getElementById('manageRoomSelect').value;
            const container = document.getElementById('roomRecords');
            if (!room || !maintenanceData[room]) { container.innerHTML = '<div class="no-data">No records for this room</div>'; return; }
            const records = maintenanceData[room].sort((a,b) => new Date(b.date) - new Date(a.date));
            container.innerHTML = '';
            records.forEach(r => {
                const item = document.createElement('div'); item.className = 'history-item';
                const date = new Date(r.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                item.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-actions"><button class="action-btn edit-btn" data-room="${room}" data-date="${r.date}" data-id="${r.id}"><i class="fas fa-edit"></i> Edit</button></div>
                `;
                container.appendChild(item);
            });
            document.querySelectorAll('#roomRecords .edit-btn').forEach(btn => {
                btn.addEventListener('click', () => { document.getElementById('manageModal').style.display = 'none'; openEditModal(btn.getAttribute('data-room'), btn.getAttribute('data-date'), btn.getAttribute('data-id')); });
            });
        }
        
        // ==================== EVENT LISTENERS ====================
        document.getElementById('addMaintenance').addEventListener('click', addMaintenanceRecord);
        document.getElementById('monthSelect').addEventListener('change', updateDisplay);
        document.getElementById('manageRecords').addEventListener('click', openManageModal);
        document.getElementById('saveEdit').addEventListener('click', saveEditedRecord);
        document.getElementById('deleteRecord').addEventListener('click', deleteRecord);
        document.getElementById('cancelEdit').addEventListener('click', () => { document.getElementById('editModal').style.display = 'none'; });
        document.getElementById('closeManage').addEventListener('click', () => { document.getElementById('manageModal').style.display = 'none'; });
        document.getElementById('manageRoomSelect').addEventListener('change', updateRoomRecordsList);
        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.style.display = 'none'; }));
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>

</html>
